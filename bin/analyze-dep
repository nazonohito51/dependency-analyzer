#!/usr/bin/env php
<?php declare(strict_types=1);

use Composer\XdebugHandler\XdebugHandler;
use DependencyAnalyzer\AnalyzeDependenciesCommand;
use PHPStan\Command\AnalyseCommand;
use PHPStan\Command\DumpDependenciesCommand;

gc_disable(); // performance boost

// TODO: This is not used anywhere.
define('__PHPSTAN_RUNNING__', true);


// TODO: require autoload
$autoloaderInWorkingDirectory = getcwd() . '/vendor/autoload.php';
if (is_file($autoloaderInWorkingDirectory)) {
	require_once $autoloaderInWorkingDirectory;
}

$composerAutoloadFile = __DIR__ . '/../vendor/autoload.php';
if (!is_file($composerAutoloadFile)) {
	$composerAutoloadFile = __DIR__ . '/../../../autoload.php';
}

require_once $composerAutoloadFile;

// TODO: check xdebug for phpstan
$xdebug = new XdebugHandler('phpstan', '--ansi');
$xdebug->check();
unset($xdebug);

// TODO: version check
$version = 'Version unknown';
try {
	$version = \Jean85\PrettyVersions::getVersion('phpstan/phpstan')->getPrettyVersion();
} catch (\OutOfBoundsException $e) {

}

$application = new \Symfony\Component\Console\Application(
	'PHP Dependency Analyzer',
	$version
);
$application->add(new AnalyzeDependenciesCommand());
//$application->add(new AnalyseCommand());
//$application->add(new DumpDependenciesCommand());
$application->run();
